<!DOCTYPE html>
<html id="html">

<head>
    <meta charset="UTF-8">
    <title>TinyPet</title>

    <meta name="google-signin-client_id" content="430963393571-7itq6p4onlaonvvcu4brhf3m5apksiaq.apps.googleusercontent.com">    
    <meta name="google-signin-plugin_name" content="stop bugging me">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">

    <link rel="stylesheet" href="style.css">

    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

    <script src="https://unpkg.com/mithril/mithril.js"></script>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
</head>

<body class="has-navbar-fixed-top">
    <script>
        var userConnecter = {
            id: null,
            prenom: "",
            name: "",
        };
        var currentURL = "/";
        var hostApi = "https://petitions-352013.ew.r.appspot.com/_ah/api/myApi/v1";
        var notification = {
            message: "",
            close: true,
            Duree: 0,
            DureeMax: 2000,
            Step: 500,
            classSup: "",
            id: null
        }
        var intervalNotificationId = null;
        function closeNotification(id = "notification") {
            clearInterval(intervalNotificationId);
            notification.close = true;
            notification.message = "";
            notification.classSup = "";
            document.getElementById(id).classList.add('hide');

        }
        function showNotification() {
            notification.Duree += notification.Step;
            if (notification.Duree >= notification.DureeMax) {
                closeNotification(notification.id);
            }
        }
        function startNotification(message, classSup = "is-primary", id = "notification") {
            notification.Duree = 0;
            notification.message = message;
            notification.classSup = classSup;
            notification.close = false;
            notification.id = id;
            document.getElementById(id).classList.remove('hide');

            intervalNotificationId = setInterval(showNotification, notification.Step);
        }
        function getItemUpdatedInView(index) {

            switch (currentURL) {
                case "/": return NewPetitionTop10.list[index];
                case "/top100Signed": return Top10SignedPetitions.list[index];
                case "/MyPetitionCreated": return API_MyPetitionCreated.list[index];
                case "/MyPetitionSigned": return API_MyPetitionSigned.list[index];
            }
        }
        function MajCardPetitionInView(index) {
            var cardView = document.getElementsByClassName("card slider")[index];

            cardView.getElementsByClassName("title")[0].innerHTML = Api_CreationPetition.item.titre;
            cardView.getElementsByClassName("subtitle")[0].innerHTML = Api_CreationPetition.item.description;
            var pourcent = Math.ceil(100 * Api_CreationPetition.item.nbSignataire / Api_CreationPetition.item.objectifSignataire);
            if (Api_CreationPetition.item.objectifSignataire == 0) {
                pourcent = 100;
            }
            cardView.getElementsByTagName("progress")[0].outerHTML = "<progress value=" + pourcent + " max=\"100\" class=\"progress is-link\"></progress>";
            cardView.getElementsByTagName("strong")[0].innerHTML = Api_CreationPetition.item.nbSignataire + " personnes ont signé";
            cardView.getElementsByTagName("span")[0].innerHTML = " d'un objectif de " + Api_CreationPetition.item.objectifSignataire + " signatures";
            cardView.getElementsByTagName("img")[0].src = Api_CreationPetition.item.img_url;
        }
        function UpdatedNbSignatureInView() {
            var cardView = document.getElementsByClassName("card slider")[API_infoPetition.index];

            var pourcent = Math.ceil(100 * API_infoPetition.item.nbSignataire / API_infoPetition.item.objectifSignataire);
            if (API_infoPetition.item.objectifSignataire == 0) {
                pourcent = 100;
            }
            cardView.getElementsByTagName("progress")[0].outerHTML = "<progress value=" + pourcent + " max=\"100\" class=\"progress is-link\"></progress>";

            cardView.getElementsByTagName("strong")[0].innerHTML = API_infoPetition.item.nbSignataire + " personnes ont signé ";

        }

        function scrollToTop() {
            window.scrollTo({ top: 0 });
        }

        function onSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            userConnecter.id = parseInt(parseInt(profile.getId()) / 1000000000000);
            userConnecter.prenom = "" + profile.getGivenName();
            userConnecter.name = "" + profile.getName();
            console.log('ID: ' + profile.getId());
            console.log('nom complet: ' + profile.getName());
            console.log('prenom: ' + profile.getGivenName());
            document.getElementById("login_google").classList.add('hide');
            document.getElementById("logout_google").classList.remove('hide');
            console.log(userConnecter);
        }
        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                userConnecter.id = null;
                userConnecter.prenom = "";
                userConnecter.name = "";
                document.getElementById("login_google").classList.remove('hide');
                document.getElementById("logout_google").classList.add('hide');
                startNotification('Vous êtes deconnecté', "is-primary", "notification");
            });
        }
        function ShowCreateAndUpdatePetitionView(idItem = null, index = null) {
            if (idItem == null) {
                Api_CreationPetition.item = getPetitionObject();
                Api_CreationPetition.index = null;
            } else {
                API_infoPetition.index = index;
                API_infoPetition.loadPetition(idItem);
                Api_CreationPetition.index = index;

            }

            document.getElementById("CreateAndUpdatePetitionView").classList.add('is-active');
            document.getElementById("html").classList.add('is-clipped');
        }
        function HideCreateAndUpdatePetitionView() {
            document.getElementById("CreateAndUpdatePetitionView").classList.remove('is-active');
            document.getElementById("html").classList.remove('is-clipped');
            Api_CreationPetition.item = getPetitionObject();
        }
        function ShowDetailPetitionView() {
            document.getElementById("DetailPetitionView").classList.add('is-active');
            document.getElementById("html").classList.add('is-clipped');
        }
        function HideDetailPetitionView() {
            document.getElementById("DetailPetitionView").classList.remove('is-active');
            document.getElementById("html").classList.remove('is-clipped');
        }
        function getPetitionObject() {
            return item = {
                ID: null,
                theme: null,
                titre: null,
                description: null,
                date: null,
                update_at: null,
                proprietaire: userConnecter.id,
                proprietaireName: userConnecter.name,
                nbSignataire: 0,
                objectifSignataire: 0,
                tag: null,
                tag_string: null,
                img_url: null
            }
        }
        function convertToPetitionObject(ApiItem) {
            return item = {
                ID: ApiItem.key.name,
                theme: null,
                titre: item.properties.titre,
                description: null,
                date: null,
                update_at: null,
                proprietaire: null,
                proprietaireName: null,
                nbSignataire: 0,
                objectifSignataire: 0,
                tag: null,
                tag_string: null,
                img_url: null
            }
        }
        var NewPetitionTop10 = {
            list: [],
            previous: ["0"],
            next: ["0"],
            loadList: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/news/top10/:id",
                    params: { id: idItem }
                })
                    .then(function (result) {

                        NewPetitionTop10.list = result.items;
                        scrollToTop();
                        var last = result.items[result.items.length - 1].key.name;
                        var previousNext = NewPetitionTop10.next[NewPetitionTop10.next.length - 1];
                        if (previousNext == undefined) {
                            previousNext = 0;
                        }
                        if (last > previousNext) {
                            NewPetitionTop10.previous.push(previousNext);
                            NewPetitionTop10.next.push(last);
                        }
                        if (last <= previousNext && NewPetitionTop10.previous.length > 2) {
                            NewPetitionTop10.previous.pop();
                            NewPetitionTop10.next.pop();
                        }
                    })
            }
        }

        var Top10SignedPetitions = {
            list: [],
            previous: "0",
            next: "0",
            loadList: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/signed/top10/:id",
                    params: { id: idItem }
                })
                    .then(function (result) {
                        Top10SignedPetitions.list = result.items;
                        scrollToTop();
                        Top10SignedPetitions.previous = Top10SignedPetitions.next;
                        Top10SignedPetitions.next = result.items[result.items.length - 1].key.name;
                    })
            }
        }
        var API_infoPetition = {
            index: 0,
            item: getPetitionObject(),
            loadPetition: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/info/:id",
                    params: { id: idItem }
                })
                    .then(function (result) {
                        API_infoPetition.item = result.properties
                        Api_CreationPetition.item = result.properties
                        Api_CreationPetition.item.ID = result.key.name
                    })
            }
        }
        var API_SignaturePetition = {
            isSigned: false,
            verifieSignature: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/signature/verifie/:petitionID/:userID",
                    params: { petitionID: idItem, userID: userConnecter.id }
                })
                    .then(function (result) {
                        API_SignaturePetition.isSigned = result.properties.signed
                    })
            },
            addSignature: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/signature/add/:petitionID/:userID",
                    params: { petitionID: idItem, userID: userConnecter.id }
                })
                    .then(function (result) {
                        startNotification(result.properties.message);
                        API_SignaturePetition.isSigned = true;
                        API_infoPetition.item.nbSignataire++;
                        UpdatedNbSignatureInView();
                    })

            },
            deleteSignature: function (idItem) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/signature/delete/:petitionID/:userID",
                    params: { petitionID: idItem, userID: userConnecter.id }
                })
                    .then(function (result) {
                        startNotification(result.properties.message);
                        API_SignaturePetition.isSigned = false;
                        API_infoPetition.item.nbSignataire--;
                        UpdatedNbSignatureInView();
                    })
            }
        }
        var API_MyPetitionCreated = {
            list: [],
            previous: ["0"],
            next: ["0"],
            loadList: function (idItem) {

                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/created/:userID/:last",
                    params: { userID: userConnecter.id, last: idItem }
                })
                    .then(function (result) {

                        API_MyPetitionCreated.list = result.items;
                        scrollToTop();

                            var last = result.items[result.items.length - 1].key.name;
                            var previousNext = API_MyPetitionCreated.next[API_MyPetitionCreated.next.length - 1];
                            if (previousNext == undefined) {
                                previousNext = 0;
                            }
                            if (last > previousNext) {
                                API_MyPetitionCreated.previous.push(previousNext);
                                API_MyPetitionCreated.next.push(last);
                            }
                            if (last <= previousNext && API_MyPetitionCreated.previous.length > 2) {
                                API_MyPetitionCreated.previous.pop();
                                API_MyPetitionCreated.next.pop();
                            }
                        
                    })
            }
        }

        var API_MyPetitionSigned = {
            list: [],
            previous: ["0"],
            next: ["0"],
            loadList: function (idItem) {

                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/list_signed/{userID}/{last}",
                    params: { userID: userConnecter.id, last: idItem }
                })
                    .then(function (result) {

                        API_MyPetitionSigned.list = result.items;
                        scrollToTop();
                            var last = result.items[result.items.length - 1].key.name;
                            var previousNext = API_MyPetitionSigned.next[API_MyPetitionSigned.next.length - 1];
                            if (previousNext == undefined) {
                                previousNext = 0;
                            }
                            if (last > previousNext) {
                                API_MyPetitionSigned.previous.push(previousNext);
                                API_MyPetitionSigned.next.push(last);
                            }
                            if (last <= previousNext && API_MyPetitionSigned.previous.length > 2) {
                                API_MyPetitionSigned.previous.pop();
                                API_MyPetitionSigned.next.pop();
                            }
                    })
            }
        }

        var API_SearchPetition = {
            list: [],
            previous: ["0"],
            next: ["0"],
            type: "titre",
            key_search: "",
            changeType: function (type) {
                API_SearchPetition.list = [];
                API_SearchPetition.previous = ["0"];
                API_SearchPetition.next = ["0"];
                API_SearchPetition.type = type;
            },
            loadList: function (idItem) {

                return m.request(
                    (API_SearchPetition.type == "tag") ?
                        {
                            method: "GET",
                            url: hostApi + "/search/tag/:tag/:last",
                            params: { tag: API_SearchPetition.key_search, last: idItem }
                        } : {
                            method: "GET",
                            url: hostApi + "/search/titre/:titre/:last",
                            params: { titre: API_SearchPetition.key_search, last: idItem }
                        }

                )
                    .then(function (result) {

                        API_SearchPetition.list = result.items;
                        scrollToTop();
                        if (result.items.length == 0) {
                            startNotification("Aucun resultat trouvé");
                        } else {
                            var last = result.items[result.items.length - 1].key.name;
                            var previousNext = API_SearchPetition.next[API_SearchPetition.next.length - 1];
                            if (previousNext == undefined) {
                                previousNext = 0;
                            }
                            if (last > previousNext) {
                                API_SearchPetition.previous.push(previousNext);
                                API_SearchPetition.next.push(last);
                            }
                            if (last <= previousNext && API_SearchPetition.previous.length > 2) {
                                API_SearchPetition.previous.pop();
                                API_SearchPetition.next.pop();
                            }
                        }


                    })
            }
        }

        var Api_CreationPetition = {
            item: getPetitionObject(),
            index: null,
            previous: ["0"],
            next: ["0"],
            loadList: function (idItem) {

            },
            createPetition: function () {
                return m.request({
                    method: "POST",
                    url: hostApi + "/petition/add",
                    body: Api_CreationPetition.item,
                })
                    .then(function (result) {
                        startNotification("Petition crée avec succès !");
                        if (currentURL != "/MyPetitionCreated") {
                            m.route.set("/MyPetitionCreated");
                        } else {
                            API_MyPetitionCreated.loadList(indexMyPetitionCreatedView);
                        }

                    })
            },
            updatePetition: function () {
                return m.request({
                    method: "POST",
                    url: hostApi + "/petition/update",
                    body: Api_CreationPetition.item,
                })
                    .then(function (result) {
                        Api_CreationPetition.item = result.properties;
                        Api_CreationPetition.item.ID = result.key.name;
                        MajCardPetitionInView(Api_CreationPetition.index);
                        startNotification("Petition modifié avec succès !");
                    })
            },
            deletePetition: function (petitionID) {
                return m.request({
                    method: "GET",
                    url: hostApi + "/petition/delete/:ID",
                    params: { ID: petitionID }
                })
                    .then(function (result) {
                        startNotification("Suppression reussie !");
                    })
            }

        }

        var indexNewPetitionTop10View, indexTop10SignedPetitionsView,
            indexMyPetitionCreatedView, indexMyPetitionSignedView, indexSearchPetitionView;
        var NewPetitionTop10View = {
            oninit: function (vnode) {
                indexNewPetitionTop10View = 0;
            },
            oncreate: function (vnode) {
                currentURL = "/";
                NewPetitionTop10.loadList(indexNewPetitionTop10View);
            },
            view: function () {
                return [NewPetitionTop10.list.map(function (item, index) {
                    return m(cardPetition, { item: item, index: index })
                }), m(paginationTop10New)]
            }
        }


        var Top10SignedPetitionsView = {
            oninit: function (vnode) {
                indexTop10SignedPetitionsView = 0;
            },
            oncreate: function (vnode) {
                currentURL = "/Top100Signed";
                Top10SignedPetitions.loadList(indexTop10SignedPetitionsView);

            },
            view: function () {
                return [Top10SignedPetitions.list.map(function (item, index) {
                    return m(cardPetition, { item: item, index: index })
                })]
            }
        }

        var MyPetitionCreatedView = {
            oninit: function (vnode) {
                indexMyPetitionCreatedView = 0;
            },
            oncreate: function (vnode) {
                currentURL = "/MyPetitionCreated";
                API_MyPetitionCreated.loadList(indexMyPetitionCreatedView);

            },
            view: function () {
                return [API_MyPetitionCreated.list.map(function (item, index) {
                    return m(cardPetition, { item: item, index: index })
                }), m(paginationMyPetitionCreated)]
            }
        }
        var MyPetitionSignedView = {
            oninit: function (vnode) {
                indexMyPetitionSignedView = 0;
            },
            oncreate: function (vnode) {
                currentURL = "/MyPetitionSigned";
                API_MyPetitionSigned.loadList(indexMyPetitionSignedView);

            },
            view: function () {
                return [API_MyPetitionSigned.list.map(function (item, index) {
                    return m(cardPetition, { item: item, index: index })
                }), m(paginationMyPetitionSigned)]
            }
        }
        var SearchPetitionView = {
            oninit: function (vnode) {
                indexSearchPetitionView = 0;
            },
            oncreate: function (vnode) {
                currentURL = "/MyPetitionSigned";
                //API_SearchPetition.loadList(indexSearchPetitionView);

            },
            view: function () {
                return [API_SearchPetition.list.map(function (item, index) {
                    return m(cardPetition, { item: item, index: index })
                }), m(paginationSearchPetition)]
            }
        }
        
        var DetailPetitionView = {
            view: function () {
                var pourcent = Math.ceil(100 * API_infoPetition.item.nbSignataire / API_infoPetition.item.objectifSignataire);
                if (API_infoPetition.item.objectifSignataire == 0) {
                    pourcent = 100;
                }
                return m("div", { "id": "DetailPetitionView", "class": "modal full" },
                    [
                        m("div", { "class": "modal-background" }),
                        m("div", { "class": "modal-card" },
                            m("form", { "class": "form" },
                                [
                                    m("section", { "class": "modal-card-body" },
                                        m("div", { "class": "tile is-ancestor is-vertical" },
                                            [
                                                m("div", { "class": "tile is-parent" },
                                                    [
                                                        m("div", { "class": "tile is-child box div_adapt" },
                                                            [
                                                                m("p", { "class": "title" }, API_infoPetition.item.titre),                                                                
                                                                m("p", { "class": "text_ligne" }, API_infoPetition.item.description),
                                                                m("br"),                                                                
                                                                m("p", { "class": "title" },
                                                                    "Informations de la pétition"
                                                                ),
                                                                m("span", { "class": "w-500" }, "L'auteur est "),
                                                                m("span", API_infoPetition.item.proprietaireName), m("br"),
                                                                m("span", { "class": "w-500" }, "Cette pétition concerne "),
                                                                m("span", API_infoPetition.item.theme), m("br"),
                                                                m("span", { "class": "w-500" }, "Elle a été créée le "),
                                                                m("span", API_infoPetition.item.date), m("br"),
                                                                m("span", { "class": "w-500" }, "La dernière modification a été faite le "),
                                                                m("span", API_infoPetition.item.update_at), m("br"),
                                                            ]
                                                        )
                                                    ]
                                                ),
                                                m("div", { "class": "tile is-vertical is-parent" },
                                                    [
                                                        m("div", { "class": "is-child box pb-0" },
                                                            [
                                                                m("p", { "class": "title" },
                                                                    "Soutenez cette pétition"
                                                                ),
                                                                m("p", { "class": "has-text-centered mb-10" },
                                                                    [
                                                                        m("strong", API_infoPetition.item.nbSignataire + " personnes ont signé"),
                                                                        m("span", " d'un objectif de " + API_infoPetition.item.objectifSignataire + " signatures"
                                                                        )
                                                                    ]
                                                                ),
                                                                m("progress", { "class": "progress is-link", "value": pourcent, "max": "100" }),
                                                                m("footer", { "class": "card-footer" },
                                                                    m("p", { "class": "card-footer-item" },
                                                                        m("span", m("a", {
                                                                            "class": "link", onclick: function (e) {
                                                                                e.preventDefault();
                                                                                if (API_infoPetition.item.proprietaire == userConnecter.id) {
                                                                                    startNotification("Operation invalide : Vous ne pouvez pas signer vos propres petitions!", "is-primary", "notificationDetailPetition")
                                                                                } else {
                                                                                    if (API_SignaturePetition.isSigned) {
                                                                                        API_SignaturePetition.deleteSignature(API_infoPetition.item.ID)

                                                                                    } else if (userConnecter.id==null){
                                                                                        startNotification("Operation invalide : Vous ne pouvez pas signer, vous n'êtes pas connectés !", "is-primary", "notificationDetailPetition")

                                                                                    } else{                                                                                        
                                                                                        API_SignaturePetition.addSignature(API_infoPetition.item.ID)
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                            API_SignaturePetition.isSigned ? "Enlever la signature" : "Signer la pétition"
                                                                        )
                                                                        )
                                                                    )
                                                                )
                                                            ]
                                                        ),
                                                        m("div", { "id": "notificationDetailPetition", class: notification.classSup == "" ? "notification hide" : "notification " + notification.classSup },
                                                            [
                                                                m("button", {
                                                                    "class": "delete", onclick: function (e) {
                                                                        e.preventDefault();
                                                                        closeNotification("notificationDetailPetition");
                                                                    }
                                                                }),
                                                                notification.message
                                                            ]
                                                        )
                                                    ]
                                                )
                                            ]
                                        )
                                    ),
                                    m("button", {
                                        onclick: function (e) {
                                            e.preventDefault();
                                            HideDetailPetitionView();
                                        }, "class": "modal-close is-large", "aria-label": "close"
                                    })
                                ]
                            )
                        )
                    ]
                )
            }

        }

        var CreateAndUpdatePetitionView = {
            view: function () {
                return m("div", { "id": "CreateAndUpdatePetitionView", "class": "modal" },
                    [
                        m("div", { "class": "modal-background" }),
                        m("div", { "class": "modal-card" },
                            m("form", {
                                "class": "form scroll-y", onsubmit: function (e) {
                                    e.preventDefault()
                                    if (Api_CreationPetition.item.ID == null) {
                                        Api_CreationPetition.createPetition();
                                    } else {
                                        Api_CreationPetition.updatePetition();
                                    }
                                    HideCreateAndUpdatePetitionView();

                                }
                            },
                                [
                                    m("header", { "class": "modal-card-head" },
                                        [
                                            m("p", { "class": "modal-card-title" },
                                                "Créer une petition"
                                            ),
                                            m("button", {
                                                onclick: function (e) {
                                                    e.preventDefault();
                                                    HideCreateAndUpdatePetitionView();
                                                }, "class": "delete", "aria-label": "close"
                                            })
                                        ]
                                    ),
                                    m("section", { "class": "modal-card-body" },
                                        [
                                            m("div", { "class": "field " },
                                                [
                                                    m("label", { "class": "label" },
                                                        "Titre*"
                                                    ),
                                                    m("div", { "class": "form-group" },
                                                        m("input", {
                                                            "class": "form-control", "type": "text", "placeholder": "Indiquez le titre de votre pétition",
                                                            oninput: function (e) { Api_CreationPetition.item.titre = e.target.value },
                                                            value: Api_CreationPetition.item.titre
                                                        })
                                                    )
                                                ]
                                            ),
                                            m("div", { "class": "field " },
                                                [
                                                    m("label", { "class": "label" },
                                                        "Thème"
                                                    ),
                                                    m("div", { "class": "form-group" },
                                                        m("input", {
                                                            "class": "form-control", "type": "text", "placeholder": "Donnez le thème general",
                                                            oninput: function (e) { Api_CreationPetition.item.theme = e.target.value },
                                                            value: Api_CreationPetition.item.theme
                                                        })
                                                    )
                                                ]
                                            ),
                                            
                                            m("div", { "class": "field " },
                                                [
                                                    m("label", { "class": "label" },
                                                        "Tag"
                                                    ),
                                                    m("div", { "class": "form-group" },
                                                        m("input", {
                                                            "class": "form-control", "type": "text", "placeholder": "Indiquez vos tags, chaque tag doit etre terminer par un point virgule ;",
                                                            oninput: function (e) { Api_CreationPetition.item.tag_string = e.target.value },
                                                            value: Api_CreationPetition.item.tag_string
                                                        })
                                                    )
                                                ]
                                            ),
                                            m("div", { "class": "field " },
                                                [
                                                    m("label", { "class": "label" },
                                                        "Nombre de signatures visés"
                                                    ),
                                                    m("div", { "class": "form-group" },
                                                        m("input", {
                                                            "class": "form-control", "type": "number", "placeholder": "Indiquez le nombre de signatures que vous souhaitez atteindre",
                                                            oninput: function (e) { Api_CreationPetition.item.objectifSignataire = e.target.value },
                                                            value: Api_CreationPetition.item.objectifSignataire
                                                        })
                                                    )
                                                ]
                                            ),
                                            m("div", { "class": "field" },
                                                [
                                                    m("label", { "class": "label" },
                                                        "Description*"
                                                    ),
                                                    m("div", { "class": "form-group" },
                                                        m("textarea", {
                                                            "class": "form-control ", "rows": "10", "placeholder": "Exprimez vous librement, et donnez tous les détails de votre pétition ",
                                                            oninput: function (e) { Api_CreationPetition.item.description = e.target.value },
                                                            value: Api_CreationPetition.item.description
                                                        })
                                                    ),
                                                    m("p", { "class": "help  is-primary is-light" },
                                                        "* signifie que l'entrée est obligatoire"
                                                    )
                                                ]
                                            ),
                                            m("div", { "class": "field" },
                                                m("div", { "class": "control" },
                                                    m("label", { "class": "checkbox" },
                                                        [
                                                            m("input", { "type": "checkbox" }),
                                                            " Je suis d'accord avec les termes et conditions "
                                                        ]
                                                    )
                                                )
                                            )
                                        ]
                                    ),
                                    m("footer", { "class": "modal-card-foot" },
                                        [
                                            m("button", { "class": "button is-primary save" },
                                                "Enregister"
                                            ),
                                            m("button", {
                                                onclick: function (e) {
                                                    e.preventDefault();
                                                    HideCreateAndUpdatePetitionView();
                                                }, "class": "button is-primary is-danger cancel"
                                            },
                                                "Annuler")
                                        ]
                                    )
                                ]
                            )
                        )
                    ]
                )
            }
        }
        var Header = {
            view: function () {

                return [m("nav", { "class": "navbar bg-light is-fixed-top box", "role": "navigation", "aria-label": "main navigation" },
                    [
                        m("div", { "class": "navbar-brand" },
                            [
                                m("a", { "class": "", "href": "/" },
                                m("strong", "Accueil")),
                                
                                
                                m("a", { "class": "navbar-burger", "role": "button", "aria-label": "menu", "aria-expanded": "false", "data-target": "navbarBasic" },
                                    [m("span", { "aria-hidden": "true" }), m("span", { "aria-hidden": "true" }), m("span", { "aria-hidden": "true" })])
                            ]
                        ),
                        m("div", { "class": "navbar-menu", "id": "navbarBasic" },
                            [
                                m("div", { "class": "navbar-start" },
                                    [
                                        m(m.route.Link, {
                                            href: "/", onclick: function (e) {
                                                currentURL = '/';
                                            }, class: currentURL == "/" ? "navbar-item fw-500 is-active" : "navbar-item fw-500"
                                        }, "Toutes les pétitions "),
                                        
                                        m(m.route.Link, {
                                            href: "/top100Signed", onclick: function (e) {currentURL = '/Top100Signed';
                                            }, class: currentURL == "/Top100Signed" ? "navbar-item fw-500 is-active" : "navbar-item fw-500" 
                                        }, " Pétitions les plus signées "),   

                                    ]
                                ),
                                m("p", { "class": "control txt-center" },
                                [
                                    m("input", {
                                        "class": "input txt-center w-60 ", "type": "text", "placeholder": "Indiquez le titre ou l'un des tags de la petition recherchée",
                                        oninput: function (e) { API_SearchPetition.key_search = e.target.value },
                                        value: API_SearchPetition.key_search
                                    }),
                                    m("a", {
                                        "class": "link dark",
                                        href: "App.html#!/SearchPetition",
                                        onclick: function (e) {

                                            API_SearchPetition.loadList(0);


                                        },
                                        class: currentURL == "/SearchPetition" 
                                    },
                                        m("span", { "class": "icon mt-8" },
                                            m("i", { "class": "fas fa-search", "aria-hidden": "true" })
                                        )
                                    )
                                ]
                            ),                              

                                m("div", { "class": "navbar-end" },

                                    console.log("ID Recup : "+userConnecter.id),        

                                    m("a", {
                                        onclick: function (e) {
                                            if(userConnecter.id == null ){
                                                startNotification("Veuillez-vous connecter pour créer une pétition");
                                            } else{
                                                ShowCreateAndUpdatePetitionView();
                                            }
                                        }, class: userConnecter.id == null ? "navbar-item fw-500 hide" : "navbar-item fw-500"
                                    }, " Ajouter une petition "),

                                    m(m.route.Link, {
                                        href: "/MyPetitionCreated", onclick: function (e) {currentURL = '/MyPetitionCreated';
                                        }, class: currentURL == "/MyPetitionCreated" || currentURL == "/MyPetitionSigned" ?  
                                            (userConnecter.id == null ? "navbar-item fw-500 is-active hide" : "navbar-item fw-500 is-active" ) : 
                                            (userConnecter.id == null ? "navbar-item fw-500 hide" : "navbar-item fw-500" )
                                    }, "Mon activité"),

                                    m("div", { "class": "navbar-item" },
                                        m("div", { "class": "buttons" },
                                            [
                                                m("div", {
                                                    "id": "notification", onclick: function (e) {
                                                        e.preventDefault();
                                                        closeNotification("notification");
                                                    }, class: notification.classSup == "" ? "notification hide" : "notification " + notification.classSup
                                                }, [m("button", { "class": "delete" }), notification.message]
                                                ),

                                                m("div", { 
                                                    "id": "login_google", 
                                                    class: userConnecter.id == null ? "g-signin2" : "g-signin2 hide", 
                                                    "data-onsuccess": "onSignIn" 
                                                }),

                                                m("a", {
                                                    "id": "logout_google", class: userConnecter.id == null ? "button is-light hide" : "button is-light", onclick: function (e) {
                                                        signOut();
                                                    }, 
                                                    "href": "#"
                                                },
                                                    m("strong",
                                                        "Se déconnecter"
                                                    )
                                                ),
                                            ]
                                        )
                                    )
                                )
                            ]
                        )
                    ]
                ),
                m(CreateAndUpdatePetitionView), m(DetailPetitionView)
                ]
            }

        }
        var TabParcourirPetition = {
            view: function () {
                return [
                    m("hr", { "class": "m-0 p-22" }),
                    m("br"),
                    m("div", { "class": "tabs is-centered m-0" },
                        m("ul",
                            [
                                m("li", { class: currentURL == "/" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/", onclick: function (e) {
                                        currentURL = '/';
                                    }
                                }, "Les pétitions récentes")),
                                m("li", { class: currentURL == "/Top100Signed" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/top100Signed", onclick: function (e) {
                                        currentURL = '/Top100Signed';
                                    }
                                }, "Top pétitions signées"))

                            ]
                        )
                    )
                ]
            }
        }
        var TabMyPetitionCreated = {
            view: function () {
                return [
                    m("hr", { "class": "m-0 p-22" }),
                    m("br"),
                    m("h2", { "class": "title is-2 has-text-centered" },
                        "Bienvenue, " + userConnecter.name
                    ),
                    m("div", { "class": "tabs is-centered m-0" },
                        m("ul",
                            [
                                m("li", { class: currentURL == "/MyPetitionCreated" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/MyPetitionCreated", onclick: function (e) {
                                        currentURL = '/MyPetitionCreated';
                                    }
                                }, "Pétition(s) lancée(s)")),
                                m("li", { class: currentURL == "/MyPetitionSigned" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/MyPetitionSigned", onclick: function (e) {
                                        currentURL = '/MyPetitionSigned';
                                    }
                                }, "Pétition(s) signée(s)"))

                            ]
                        )
                    )
                ]
            }
        }

        var TabMyPetitionSigned = {
        view: function () {
                return [
                    m("hr", { "class": "m-0 p-22" }),
                    m("br"),
                    m("h2", { "class": "title is-2 has-text-centered" },
                        "Bienvenue, " + userConnecter.name
                    ),
                    m("div", { "class": "tabs is-centered m-0" },
                        m("ul",
                            [
                                m("li", { class: currentURL == "/MyPetitionCreated" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/MyPetitionCreated", onclick: function (e) {
                                        currentURL = '/MyPetitionCreated';
                                    }
                                }, "Pétition(s) lancée(s)")),
                                m("li", { class: currentURL == "/MyPetitionSigned" ? "is-active" : "" }, m(m.route.Link, {
                                    href: "/MyPetitionSigned", onclick: function (e) {
                                        currentURL = '/MyPetitionSigned';
                                    }
                                }, "Pétition(s) signée(s)"))

                            ]
                        )
                    )
                ]
            }
        }
        var TabSearchPetition = {
            view: function () {
                return [
                    m("hr", { "class": "m-0 p-22" }),
                    m("br"),
                    m("h2", { "class": "title is-2 has-text-centered" },
                        "Rechercher des pétitions"
                    ),
                ]
            }
        }
        var TabDetailPetition = {
            view: function () {
                return [
                    m("hr", { "class": "m-0 p-22" }),
                    m("br"),
                    m("h2", { "class": "title is-2 has-text-centered" },
                        "Détails de la pétition"
                    ),
                    m("div", { "class": "tabs is-centered m-0" },
                        m("ul", { "class": "scroll-x" },
                            [
                                m("span", { "class": "w-500" },
                                    " Liste de tags : "
                                ), API_infoPetition.item.tag == null ? "" : API_infoPetition.item.tag.map(function (item) {
                                    return m("span", { "class": "tag is-rounded" },
                                        item
                                    )
                                })
                            ]
                        )
                    )
                ]
            }
        }

        var cardPetition = {
            view: function (vnode) {
                var item = vnode.attrs.item;
                var index = vnode.attrs.index;
                var pourcent = Math.ceil(100 * item.properties.nbSignataire / item.properties.objectifSignataire);
                if (item.properties.objectifSignataire == 0) {
                    pourcent = 100;
                }

                return m("div", { class: item.deleted != null ? "card slider closed " : "card slider border-dark" },
                    [
                        m("div", { "class": "card-header border-dark" },
                            m("p", { "class": "title" }, item.properties.titre),
                        ),
                        m("div", { "class": "card-content border-dark" },
                            [
                                
                                m("p", { "class": "subtitle truncate" }, item.properties.description),
                                m("progress", { "class": "progress is-link", "value": pourcent, "max": "100" }),
                                m("p", { "class": "has-text-centered" },
                                    [
                                        m("strong", item.properties.nbSignataire + " personnes ont signé "),
                                        m("span", "d'un objectif de " + item.properties.objectifSignataire + " signatures")
                                    ]
                                )
                            ]
                        ),
                        m("footer", { "class": "card-footer border-dark" },
                            item.properties.proprietaire == userConnecter.id ? [
                                m("p", { "class": "card-footer-item" },
                                    m("span",
                                        m("a", {
                                            "class": "link",
                                            onclick: function (e) {
                                                item.deleted = true;
                                                Api_CreationPetition.deletePetition(item.key.name);

                                            }
                                        }, [
                                            m("span", { class: "" }, "Supprimer")
                                        ])
                                    )
                                ),
                                m("p", { "class": "card-footer-item" },
                                    m("span",
                                        m("a", {
                                            "class": "link",
                                            onclick: function (e) {
                                                ShowCreateAndUpdatePetitionView(item.key.name, index);
                                            }
                                        }, [
                                            m("span", { class: "" }, "Modifier")
                                        ])
                                    )
                                )
                            ] : "",
                            m("p", { "class": "card-footer-item" },
                                m("span",
                                    m("a", {
                                        "class": "link",
                                        onclick: function (e) {
                                            API_infoPetition.index = index;
                                            API_infoPetition.loadPetition(item.key.name)
                                            API_SignaturePetition.verifieSignature(item.key.name);
                                            ShowDetailPetitionView();
                                        }
                                    }, [
                                        m("span", { class: "" }, "Voir la pétition")
                                    ])
                                )
                            )
                        )
                    ]
                )
            }
        }
        var paginationTop10New = {
            view: function () {
                return NewPetitionTop10.list.length < 10 ? "" : m("nav", { "class": "pagination is-rounded", "role": "navigation", "aria-label": "pagination" },
                    [

                        m(m.route.Link, {
                            "class": "pagination-previous", href: "/", onclick: function (e) {
                                indexNewPetitionTop10View = NewPetitionTop10.previous[NewPetitionTop10.previous.length - 2];
                                if (indexNewPetitionTop10View == undefined) {
                                    indexNewPetitionTop10View = 0;
                                }
                                NewPetitionTop10.loadList(indexNewPetitionTop10View)

                            }
                        }, "Page précédente"),
                        m(m.route.Link, {
                            "class": "pagination-next", href: "/", onclick: function (e) {
                                indexNewPetitionTop10View = NewPetitionTop10.next[NewPetitionTop10.next.length - 1];
                                NewPetitionTop10.loadList(indexNewPetitionTop10View)
                            }
                        }, "Page suivante")
                    ]
                )
            }
        }

        var paginationMyPetitionCreated = {
            view: function () {
                return API_MyPetitionCreated.list.length < 10 ? "" : m("nav", { "class": "pagination is-rounded", "role": "navigation", "aria-label": "pagination" },
                    [

                        m(m.route.Link, {
                            "class": "pagination-previous", href: "/", onclick: function (e) {
                                indexMyPetitionCreatedView = API_MyPetitionCreated.previous[API_MyPetitionCreated.previous.length - 2];
                                if (indexMyPetitionCreatedView == undefined) {
                                    indexMyPetitionCreatedView = 0;
                                }
                                API_MyPetitionCreated.loadList(indexMyPetitionCreatedView)

                            }
                        }, "Page précédente"),
                        m(m.route.Link, {
                            "class": "pagination-next", href: "/", onclick: function (e) {
                                indexMyPetitionCreatedView = API_MyPetitionCreated.next[API_MyPetitionCreated.next.length - 1];
                                API_MyPetitionCreated.loadList(indexMyPetitionCreatedView)
                            }
                        }, "Page suivante")
                    ]
                )
            }
        }
        var paginationMyPetitionSigned = {
            view: function () {
                return API_MyPetitionSigned.list.length < 10 ? "" : m("nav", { "class": "pagination is-rounded", "role": "navigation", "aria-label": "pagination" },
                    [

                        m(m.route.Link, {
                            "class": "pagination-previous", href: "/", onclick: function (e) {
                                indexMyPetitionSignedView = API_MyPetitionSigned.previous[API_MyPetitionSigned.previous.length - 2];
                                if (indexMyPetitionSignedView == undefined) {
                                    indexMyPetitionSignedView = 0;
                                }
                                API_MyPetitionSigned.loadList(indexMyPetitionSignedView)

                            }
                        }, "Page précédente"),
                        m(m.route.Link, {
                            "class": "pagination-next", href: "/", onclick: function (e) {
                                indexMyPetitionSignedView = API_MyPetitionSigned.next[API_MyPetitionSigned.next.length - 1];
                                API_MyPetitionSigned.loadList(indexMyPetitionSignedView)
                            }
                        }, "Page suivante")
                    ]
                )
            }
        }

        var paginationSearchPetition = {
            view: function () {
                return API_SearchPetition.list.length < 10 ? "" : m("nav", { "class": "pagination is-rounded", "role": "navigation", "aria-label": "pagination" },
                    [

                        m(m.route.Link, {
                            "class": "pagination-previous", href: "/", onclick: function (e) {
                                indexSearchPetitionView = API_SearchPetition.previous[API_SearchPetition.previous.length - 2];
                                if (indexSearchPetitionView == undefined) {
                                    indexSearchPetitionView = 0;
                                }
                                API_SearchPetition.loadList(indexSearchPetitionView)

                            }
                        }, "Page précédente"),
                        m(m.route.Link, {
                            "class": "pagination-next", href: "/", onclick: function (e) {
                                indexSearchPetitionView = API_SearchPetition.next[API_SearchPetition.next.length - 1];
                                API_SearchPetition.loadList(indexSearchPetitionView)
                            }
                        }, "Page suivante")
                    ]
                )
            }
        }
        var Home = {
            view: function () {
                return [m(Header),              
                m("br"),    
                m("br"),    
                m('div', { class: 'p-30 cendre' }, [
                    m(NewPetitionTop10View)
                ])]
            }
        }
        var Top100Signed = {
            view: function () {
                return [m(Header),                
                m("br"),    
                m("br"),                                                          
                m('div', { class: 'p-30 cendre' }, [
                    m(Top10SignedPetitionsView)
                ])]
            }
        }
        var infoPetition = {
            view: function () {
                return [m(Header), m(TabDetailPetition),
                m('div', { class: 'p-30 cendre' }, [
                    m(infoPetitionView)
                ])
                ]
            }
        }

        var MyPetitionCreated = {
            view: function () {
                return [m(Header), m(TabMyPetitionCreated),
                m('div', { class: 'p-30 cendre' }, [
                    m(MyPetitionCreatedView)
                ])]
            }
        }
        var MyPetitionSigned = {
            view: function () {
                return [m(Header), m(TabMyPetitionSigned),
                m('div', { class: 'p-30 cendre' }, [
                    m(MyPetitionSignedView)
                ])]
            }
        }
        var SearchPetition = {
            view: function () {
                return [m(Header), m(TabSearchPetition),
                m('div', { class: 'p-30 cendre' }, [
                    m(SearchPetitionView)
                ])]
            }
        }

        m.route(document.body, "/", {
            "/": Home,
            "/top100Signed": Top100Signed,
            "/MyPetitionCreated": MyPetitionCreated,
            "/MyPetitionSigned": MyPetitionSigned,
            "/SearchPetition": SearchPetition,
        })
    </script>
</body>

</html>
